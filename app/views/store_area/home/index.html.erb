<div class="container-fluid p-0">
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0">Ciclos</h5>
        </div>
        <div class="card-body">
          <div class="row text-center mb-4">
            <div class="col">
              <h2 class="mb-0"><%= @cycles.count %></h2>
              <p class="text-muted mb-0">Total de Ciclos</p>
            </div>
          </div>

          <%= pie_chart @cycles_count, 
              colors: ["#4e73df", "#1cc88a", "#e74a3b"],
              legend: "bottom",
              donut: true,
              defer: true %>
          
          <div class="row text-center mt-4">
            <div class="col">
              <h3 class="mb-0"><%= @cycles.select { |c| !c.canceled? && c.washer? }.count %></h3>
              <p class="text-muted mb-0">Lavagens</p>
            </div>
            <div class="col">
              <h3 class="mb-0"><%= @cycles.select { |c| !c.canceled? && c.dryer? }.count %></h3>
              <p class="text-muted mb-0">Secagens</p>
            </div>
            <div class="col">
              <h3 class="mb-0"><%= @cycles.select { |c| c.canceled? }.count %></h3>
              <p class="text-muted mb-0">Estornos</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0">Clientes</h5>
        </div>
        <div class="card-body">
          <div class="row text-center mb-4">
            <div class="col">
              <h2 class="mb-0"><%= @customers.count %></h2>
              <p class="text-muted mb-0">Total de Clientes</p>
            </div>
          </div>

          <%= pie_chart @customers_count,
              colors: ["#4e73df", "#1cc88a"],
              legend: "bottom",
              donut: true,
              defer: true %>
          
          <div class="row text-center mt-4">
            <div class="col">
              <h3 class="mb-0"><%= @customers.select { |c| c.area_code == @current_store.area_code }.count %></h3>
              <p class="text-muted mb-0">Clientes Locais</p>
            </div>
            <div class="col">
              <h3 class="mb-0"><%= @customers.select { |c| c.area_code != @current_store.area_code }.count %></h3>
              <p class="text-muted mb-0">Clientes Externos</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0">Clientes por Mês</h5>
        </div>
        <div class="card-body">
          <%= column_chart([
            {
              name: 'Clientes Locais',
              data: @customers_per_type.select { |c| c[:type] == 'local' }.map { |c| c.except(:type) }.map(&:values).flatten
            },
            {
              name: 'Clientes Visitantes',
              data: @customers_per_type.select { |c| c[:type] == 'others' }.map { |c| c.except(:type) }.map(&:values).flatten
            }
          ], stacked: true, xtitle: 'Mêses', ytitle: 'Clientes', 
             colors: ['#43BCCD', '#F86624'],
             defer: true,
             library: {
               xAxis: {
                 categories: @customers_per_type.select { |c| c[:type] == 'others' }.map { |c| c.except(:type) }.map(&:keys).flatten.uniq.sort.map(&:to_s)
               }
             }) %>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0">Ciclos por Clientes</h5>
        </div>
        <div class="card-body">
          <%= column_chart @cycles_per_customer_type,
              colors: ["#4e73df", "#1cc88a"],
              legend: "bottom",
              defer: true %>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0">Ciclos por Dia da Semana e Horário</h5>
        </div>
        <div class="card-body">
          <%= column_chart([
            {
              name: "Noite",
              data: @current_store.cycles.group_by_weekday_and_period.transform_values { |periods| periods[:evening] || 0 },
              color: "#1f507a"
            },
            {
              name: "Tarde",
              data: @current_store.cycles.group_by_weekday_and_period.transform_values { |periods| periods[:afternoon] || 0 },
              color: "#F7B632"
            },
            {
              name: "Manhã",
              data: @current_store.cycles.group_by_weekday_and_period.transform_values { |periods| periods[:morning] || 0 },
              color: "#3692e2"
            }
          ], stacked: true,
             defer: true,
             library: {
               xAxis: {
                 categories: @current_store.cycles.group_by_weekday_and_period.keys
               }
             }) %>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0">Média de Ciclos por Mês</h5>
        </div>
        <div class="card-body">
          <%= line_chart @avg_cycles_per_month,
              colors: ["#4e73df"],
              legend: "bottom",
              defer: true %>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0">Métricas de Clientes</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-12">
              <%= column_chart([
                {
                  name: 'Clientes Locais Novos',
                  data: @visits_data[:local_visits].transform_values { |v| v || 0 },
                  color: "#43BCCD"
                },
                {
                  name: 'Clientes Externos Novos',
                  data: @visits_data[:foreign_visits].transform_values { |v| v || 0 },
                  color: "#F86624"
                },
                {
                  name: 'Clientes Locais Recorrentes',
                  data: @visits_data[:old_local_visits].transform_values { |v| v || 0 },
                  color: "#3692e2"
                },
                {
                  name: 'Clientes Externos Recorrentes',
                  data: @visits_data[:old_foreign_visits].transform_values { |v| v || 0 },
                  color: "#F7B632"
                }
              ],
              stacked: true,
              defer: true,
              title: "Visitas por Tipo de Cliente",
              xtitle: "Mês",
              ytitle: "Visitas") %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('turbo:load', function() {
    Chartkick.eachChart(function(chart) {
      chart.redraw();
    });
  });
</script>
